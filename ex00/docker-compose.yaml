services:
    # MongoDB Database
    mongodb:
        image: mongo:7.0
        container_name: servicedeskai-mongodb
        restart: unless-stopped
        environment:
            MONGO_INITDB_DATABASE: servicedeskai
        ports:
            - '27017:27017'
        volumes:
            - mongodb_data:/data/db
        networks:
            - servicedeskai-network
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
            interval: 5s
            timeout: 5s
            retries: 5
            start_period: 10s

    # Backend API
    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: servicedeskai-backend
        restart: unless-stopped
        ports:
            - '5000:5000'
        env_file:
            - ./backend/.env
        depends_on:
            mongodb:
                condition: service_healthy
        networks:
            - servicedeskai-network
        volumes:
            - ./backend:/app
            - /app/node_modules
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    # Frontend React App
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
            args:
                - VITE_API_URL=${VITE_API_URL:-http://localhost:5000/api}
        container_name: servicedeskai-frontend
        restart: unless-stopped
        ports:
            - '5173:5173'
        env_file:
            - ./frontend/.env
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - servicedeskai-network

networks:
    servicedeskai-network:
        driver: bridge

volumes:
    mongodb_data:
